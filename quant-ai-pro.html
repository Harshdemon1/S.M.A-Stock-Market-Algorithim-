<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QUANT.AI PRO — Live Equity Screener</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Unbounded:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #04070a;
    --surface: #080e14;
    --surface2: #0d1520;
    --surface3: #111d2b;
    --border: #1a2535;
    --border2: #243347;
    --accent: #00e5ff;
    --accent-dim: rgba(0,229,255,0.12);
    --green: #00ff9d;
    --green-dim: rgba(0,255,157,0.1);
    --red: #ff4566;
    --red-dim: rgba(255,69,102,0.1);
    --gold: #ffd700;
    --gold-dim: rgba(255,215,0,0.1);
    --text: #d4e8f7;
    --muted: #4a6a85;
    --muted2: #2a4a65;
    --font: 'DM Mono', monospace;
    --display: 'Unbounded', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: 
      radial-gradient(ellipse 60% 40% at 20% 20%, rgba(0,229,255,0.04) 0%, transparent 60%),
      radial-gradient(ellipse 40% 60% at 80% 80%, rgba(0,255,157,0.03) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,229,255,0.025) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,255,0.025) 1px, transparent 1px);
    background-size: 48px 48px;
    pointer-events: none;
    z-index: 0;
  }

  .wrap {
    max-width: 1300px;
    margin: 0 auto;
    padding: 0 20px;
    position: relative;
    z-index: 1;
  }

  /* ── Header ── */
  header {
    padding: 36px 0 28px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 32px;
  }

  .header-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 20px;
    flex-wrap: wrap;
  }

  .brand .logo {
    font-family: var(--display);
    font-size: 1.9rem;
    font-weight: 900;
    letter-spacing: -0.04em;
    color: var(--text);
    line-height: 1;
  }

  .brand .logo em {
    color: var(--accent);
    font-style: normal;
  }

  .brand .sub {
    font-size: 0.6rem;
    color: var(--muted);
    letter-spacing: 0.18em;
    text-transform: uppercase;
    margin-top: 6px;
  }

  .header-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 8px;
  }

  .live-pill {
    display: flex;
    align-items: center;
    gap: 7px;
    background: var(--green-dim);
    border: 1px solid rgba(0,255,157,0.2);
    border-radius: 20px;
    padding: 5px 12px;
    font-size: 0.62rem;
    color: var(--green);
    letter-spacing: 0.12em;
    text-transform: uppercase;
  }

  .live-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--green);
    animation: blink 1.8s infinite;
  }

  @keyframes blink {
    0%,100% { opacity:1; box-shadow: 0 0 6px var(--green); }
    50% { opacity:0.3; box-shadow: none; }
  }

  .fmp-badge {
    font-size: 0.58rem;
    color: var(--muted);
    letter-spacing: 0.1em;
  }

  /* ── API Key input ── */
  .api-panel {
    background: var(--surface);
    border: 1px solid var(--border2);
    border-radius: 8px;
    padding: 20px 24px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }

  .api-panel .key-label {
    font-size: 0.65rem;
    color: var(--accent);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    white-space: nowrap;
  }

  .api-panel input {
    flex: 1;
    min-width: 200px;
    background: var(--surface2);
    border: 1px solid var(--border2);
    color: var(--text);
    padding: 10px 14px;
    font-family: var(--font);
    font-size: 0.78rem;
    border-radius: 5px;
    outline: none;
    transition: border-color 0.2s;
    letter-spacing: 0.05em;
  }

  .api-panel input:focus { border-color: var(--accent); }

  .api-hint {
    font-size: 0.6rem;
    color: var(--muted);
    line-height: 1.5;
  }

  .api-hint a { color: var(--accent); text-decoration: none; }

  /* ── Controls ── */
  .controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    margin-bottom: 12px;
    align-items: end;
  }

  .ctrl-group label {
    display: block;
    font-size: 0.58rem;
    color: var(--muted);
    letter-spacing: 0.14em;
    text-transform: uppercase;
    margin-bottom: 7px;
  }

  select, input[type="number"], input[type="text"] {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border2);
    color: var(--text);
    padding: 10px 14px;
    font-family: var(--font);
    font-size: 0.75rem;
    border-radius: 5px;
    outline: none;
    transition: border-color 0.2s;
    appearance: none;
    cursor: pointer;
  }

  select:focus, select:hover,
  input:focus, input:hover { border-color: var(--accent); }

  .run-btn {
    background: var(--accent);
    color: var(--bg);
    border: none;
    padding: 11px 24px;
    font-family: var(--display);
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.06em;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    width: 100%;
  }

  .run-btn:hover { background: #33eeff; transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,229,255,0.2); }
  .run-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }

  /* ── Ticker input ── */
  .ticker-row {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
    align-items: flex-end;
    flex-wrap: wrap;
  }

  .ticker-row .ctrl-group { flex: 1; min-width: 200px; }

  /* ── Summary cards ── */
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
    margin-bottom: 28px;
  }

  .sum-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 7px;
    padding: 14px 16px;
    transition: border-color 0.2s;
  }

  .sum-card:hover { border-color: var(--border2); }

  .sum-card .sc-label {
    font-size: 0.56rem;
    color: var(--muted);
    letter-spacing: 0.14em;
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .sum-card .sc-val {
    font-family: var(--display);
    font-size: 1.4rem;
    font-weight: 700;
    letter-spacing: -0.03em;
    line-height: 1;
  }

  .sum-card .sc-sub {
    font-size: 0.58rem;
    color: var(--muted);
    margin-top: 4px;
  }

  /* ── Results table ── */
  .table-head {
    display: grid;
    grid-template-columns: 180px 90px 80px 80px 80px 80px 80px 110px 100px;
    gap: 8px;
    padding: 8px 16px;
    font-size: 0.55rem;
    color: var(--muted);
    letter-spacing: 0.14em;
    text-transform: uppercase;
    border-bottom: 1px solid var(--border);
    margin-bottom: 6px;
  }

  .stock-row {
    display: grid;
    grid-template-columns: 180px 90px 80px 80px 80px 80px 80px 110px 100px;
    gap: 8px;
    align-items: center;
    padding: 14px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 7px;
    margin-bottom: 6px;
    transition: all 0.2s;
    cursor: default;
    animation: fadeUp 0.5s ease both;
  }

  @keyframes fadeUp {
    from { opacity:0; transform: translateY(10px); }
    to { opacity:1; transform: translateY(0); }
  }

  .stock-row:hover {
    border-color: var(--accent);
    background: var(--surface2);
    transform: translateX(3px);
    box-shadow: -3px 0 0 var(--accent);
  }

  .stock-row.rank-1 { border-color: rgba(255,215,0,0.35); background: rgba(255,215,0,0.03); }
  .stock-row.rank-2 { border-color: rgba(0,255,157,0.25); }
  .stock-row.rank-3 { border-color: rgba(0,229,255,0.2); }

  .si-ticker {
    font-family: var(--display);
    font-weight: 700;
    font-size: 0.95rem;
    letter-spacing: -0.01em;
    color: var(--text);
  }

  .si-name {
    font-size: 0.58rem;
    color: var(--muted);
    margin-top: 3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 170px;
  }

  .rank-badge {
    font-size: 0.5rem;
    padding: 2px 7px;
    border-radius: 3px;
    margin-top: 4px;
    display: inline-block;
    font-weight: 700;
    letter-spacing: 0.1em;
  }

  .rank-gold { background: var(--gold-dim); color: var(--gold); border: 1px solid rgba(255,215,0,0.3); }
  .rank-silver { background: var(--green-dim); color: var(--green); border: 1px solid rgba(0,255,157,0.3); }
  .rank-bronze { background: var(--accent-dim); color: var(--accent); border: 1px solid rgba(0,229,255,0.3); }

  .cell {
    font-size: 0.74rem;
  }

  .pos { color: var(--green); }
  .neg { color: var(--red); }
  .neu { color: var(--text); }
  .dim { color: var(--muted); }

  /* Score visualisation */
  .score-col {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .score-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .score-number {
    font-family: var(--display);
    font-size: 1rem;
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  .score-bars {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .mini-bar {
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
    display: flex;
    align-items: center;
  }

  .mini-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 1s ease;
  }

  /* Signal badge */
  .sig {
    font-size: 0.6rem;
    padding: 5px 10px;
    border-radius: 4px;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-align: center;
    font-family: var(--display);
  }

  .sig-sb { background: var(--green-dim); color: var(--green); border: 1px solid rgba(0,255,157,0.3); }
  .sig-b  { background: var(--accent-dim); color: var(--accent); border: 1px solid rgba(0,229,255,0.3); }
  .sig-h  { background: rgba(255,255,255,0.04); color: var(--muted); border: 1px solid var(--border); }
  .sig-av { background: var(--red-dim); color: var(--red); border: 1px solid rgba(255,69,102,0.3); }

  /* Loading */
  .loader {
    padding: 80px 0;
    text-align: center;
  }

  .loader-title {
    font-family: var(--display);
    font-size: 0.8rem;
    color: var(--accent);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 20px;
  }

  .progress-track {
    width: 280px;
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    margin: 0 auto 12px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--green));
    border-radius: 2px;
    width: 0%;
    transition: width 0.4s ease;
  }

  .loader-step {
    font-size: 0.62rem;
    color: var(--muted);
    letter-spacing: 0.1em;
    min-height: 18px;
  }

  /* Empty / error */
  .state-msg {
    text-align: center;
    padding: 80px 0;
  }

  .state-msg .big {
    font-family: var(--display);
    font-size: 2.5rem;
    font-weight: 900;
    color: var(--border2);
    margin-bottom: 12px;
    letter-spacing: -0.03em;
  }

  .state-msg p { font-size: 0.72rem; color: var(--muted); line-height: 1.7; }

  /* Methodology */
  .method-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 22px 24px;
    margin-bottom: 24px;
  }

  .method-panel h3 {
    font-family: var(--display);
    font-size: 0.75rem;
    color: var(--accent);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 14px;
  }

  .factors {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
  }

  .factor-card {
    border-left: 2px solid var(--accent);
    padding: 10px 14px;
    background: var(--surface2);
    border-radius: 0 5px 5px 0;
  }

  .factor-card.f-mom { border-color: var(--gold); }
  .factor-card.f-val { border-color: var(--green); }
  .factor-card.f-gro { border-color: var(--accent); }
  .factor-card.f-qua { border-color: #b388ff; }
  .factor-card.f-ins { border-color: #ff9d4d; }

  .fc-name { font-size: 0.68rem; font-weight: 500; color: var(--text); margin-bottom: 3px; }
  .fc-weight { font-size: 0.58rem; color: var(--muted); margin-bottom: 6px; }
  .fc-metrics { font-size: 0.6rem; color: var(--muted); line-height: 1.5; }

  /* Disclaimer */
  .disc {
    margin-top: 36px;
    padding: 14px 18px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.6rem;
    color: var(--muted);
    line-height: 1.7;
    margin-bottom: 40px;
  }

  .disc strong { color: var(--red); }

  /* Detail modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(4,7,10,0.9);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    backdrop-filter: blur(4px);
    animation: fadeIn 0.2s ease;
  }

  @keyframes fadeIn { from{opacity:0} to{opacity:1} }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border2);
    border-radius: 10px;
    padding: 28px;
    max-width: 560px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    animation: slideUp 0.25s ease;
  }

  @keyframes slideUp { from{transform:translateY(20px)} to{transform:translateY(0)} }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 22px;
  }

  .modal-ticker {
    font-family: var(--display);
    font-size: 1.8rem;
    font-weight: 900;
    letter-spacing: -0.04em;
    color: var(--text);
  }

  .modal-close {
    background: none;
    border: 1px solid var(--border2);
    color: var(--muted);
    width: 32px; height: 32px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .modal-close:hover { border-color: var(--accent); color: var(--accent); }

  .modal-score-big {
    font-family: var(--display);
    font-size: 3.5rem;
    font-weight: 900;
    letter-spacing: -0.04em;
    line-height: 1;
    margin-bottom: 20px;
  }

  .modal-factors {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
  }

  .mf-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px 14px;
  }

  .mf-label { font-size: 0.6rem; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 6px; }
  .mf-val { font-size: 1rem; font-weight: 500; }
  .mf-bar { height: 4px; background: var(--border); border-radius: 2px; margin-top: 6px; overflow: hidden; }
  .mf-fill { height: 100%; border-radius: 2px; }

  .modal-analysis {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 14px 16px;
    font-size: 0.68rem;
    color: var(--text);
    line-height: 1.7;
  }

  .modal-analysis h4 {
    font-family: var(--display);
    font-size: 0.65rem;
    color: var(--accent);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  @media (max-width: 900px) {
    .table-head { display: none; }
    .stock-row { grid-template-columns: 1fr 1fr 1fr; }
    .summary-grid { grid-template-columns: repeat(3, 1fr); }
  }

  @media (max-width: 600px) {
    .stock-row { grid-template-columns: 1fr 1fr; }
    .summary-grid { grid-template-columns: 1fr 1fr; }
    .modal-factors { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <header>
    <div class="header-row">
      <div class="brand">
        <div class="logo">QUANT<em>.</em>AI <span style="font-size:0.55em;opacity:0.5">PRO</span></div>
        <div class="sub">Live Quantitative Equity Analysis Engine — Powered by FMP</div>
      </div>
      <div class="header-right">
        <div class="live-pill"><div class="live-dot"></div>Live Data</div>
        <div class="fmp-badge">financialmodelingprep.com</div>
      </div>
    </div>
  </header>

  <!-- API Key Panel -->
  <div class="api-panel">
    <span class="key-label">// FMP API Key</span>
    <input type="text" id="apiKey" placeholder="Paste your free API key here..." autocomplete="off">
    <div class="api-hint">
      Free key at <a href="https://financialmodelingprep.com/developer/docs/" target="_blank">financialmodelingprep.com</a> — takes 2 mins to register. 250 free calls/day.
    </div>
  </div>

  <!-- Methodology -->
  <div class="method-panel">
    <h3>// Scoring Factors — Real Live Data</h3>
    <div class="factors">
      <div class="factor-card f-mom">
        <div class="fc-name">Momentum (20%)</div>
        <div class="fc-weight">Price performance</div>
        <div class="fc-metrics">1M, 3M, 6M, 12M returns · RSI · 52-week position</div>
      </div>
      <div class="factor-card f-val">
        <div class="fc-name">Value (20%)</div>
        <div class="fc-weight">Relative valuation</div>
        <div class="fc-metrics">P/E · P/B · P/S · EV/EBITDA · PEG ratio</div>
      </div>
      <div class="factor-card f-gro">
        <div class="fc-name">Growth (25%)</div>
        <div class="fc-weight">Business trajectory</div>
        <div class="fc-metrics">Revenue YoY · EPS growth · Forward estimates</div>
      </div>
      <div class="factor-card f-qua">
        <div class="fc-name">Quality (20%)</div>
        <div class="fc-weight">Financial health</div>
        <div class="fc-metrics">Gross/net margin · ROE · Debt/Equity · Current ratio</div>
      </div>
      <div class="factor-card f-ins">
        <div class="fc-name">Sentiment (15%)</div>
        <div class="fc-weight">Smart money signals</div>
        <div class="fc-metrics">Analyst ratings · Earnings surprises · Insider buying</div>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="ticker-row">
    <div class="ctrl-group" style="flex:2">
      <label>Stock Tickers (comma separated)</label>
      <input type="text" id="tickers" value="AAPL,MSFT,NVDA,META,GOOGL,AMZN,TSLA,AMD,JPM,V,LLY,UNH,XOM,COST,ABBV" placeholder="e.g. AAPL,MSFT,NVDA,JPM">
    </div>
  </div>

  <div class="controls">
    <div class="ctrl-group">
      <label>Strategy</label>
      <select id="strategy">
        <option value="balanced">Balanced</option>
        <option value="momentum">High Momentum</option>
        <option value="value">Deep Value</option>
        <option value="growth">Growth Focus</option>
        <option value="quality">Quality First</option>
      </select>
    </div>
    <div class="ctrl-group">
      <label>Min QUANT Score</label>
      <input type="number" id="minScore" value="0" min="0" max="100">
    </div>
    <div class="ctrl-group">
      <label>Sort By</label>
      <select id="sortBy">
        <option value="score">QUANT Score</option>
        <option value="momentum">Momentum</option>
        <option value="growth">Growth</option>
        <option value="value">Value</option>
        <option value="quality">Quality</option>
      </select>
    </div>
    <div class="ctrl-group">
      <label>&nbsp;</label>
      <button class="run-btn" id="runBtn" onclick="runScreener()">▶ ANALYSE STOCKS</button>
    </div>
  </div>

  <!-- Summary -->
  <div id="summaryGrid" class="summary-grid" style="display:none"></div>

  <!-- Results -->
  <div id="resultArea">
    <div class="state-msg">
      <div class="big">QUANT.AI</div>
      <p>Enter your FMP API key above, add tickers, and hit Analyse.<br>The algorithm will fetch live data and score each stock.</p>
    </div>
  </div>

  <div class="disc">
    <strong>⚠ DISCLAIMER:</strong> QUANT.AI PRO is an educational and portfolio demonstration project. Data is fetched live from Financial Modeling Prep (FMP) public APIs. Scores and signals are algorithmic outputs and do not constitute financial advice. Markets involve risk — always consult a qualified financial advisor before investing. Past performance does not guarantee future results.
  </div>

</div>

<!-- Detail Modal -->
<div id="modalOverlay" class="modal-overlay" style="display:none" onclick="closeModal(event)">
  <div class="modal" id="modalContent"></div>
</div>

<script>
const API_BASE = 'https://financialmodelingprep.com/api/v3';
const API_BASE_V4 = 'https://financialmodelingprep.com/api/v4';

let cachedResults = [];

function getKey() { return document.getElementById('apiKey').value.trim(); }

async function fmp(endpoint, v4=false) {
  const key = getKey();
  if (!key) throw new Error('No API key');
  const base = v4 ? API_BASE_V4 : API_BASE;
  const sep = endpoint.includes('?') ? '&' : '?';
  const res = await fetch(`${base}${endpoint}${sep}apikey=${key}`);
  if (!res.ok) throw new Error(`FMP error ${res.status}`);
  return res.json();
}

// ── Fetch all data for a ticker ──
async function fetchStockData(ticker) {
  try {
    const [quote, profile, metrics, income, ratings] = await Promise.allSettled([
      fmp(`/quote/${ticker}`),
      fmp(`/profile/${ticker}`),
      fmp(`/key-metrics-ttm/${ticker}`),
      fmp(`/income-statement/${ticker}?period=annual&limit=2`),
      fmp(`/rating/${ticker}`),
    ]);

    const q = quote.value?.[0];
    const p = profile.value?.[0];
    const m = metrics.value?.[0];
    const inc = income.value;
    const rat = ratings.value?.[0];

    if (!q || !p) return null;

    // Revenue growth
    let revenueGrowth = null;
    if (inc && inc.length >= 2) {
      const rev0 = inc[0]?.revenue, rev1 = inc[1]?.revenue;
      if (rev0 && rev1 && rev1 !== 0) revenueGrowth = ((rev0 - rev1) / Math.abs(rev1)) * 100;
    }

    // EPS growth
    let epsGrowth = null;
    if (inc && inc.length >= 2) {
      const e0 = inc[0]?.eps, e1 = inc[1]?.eps;
      if (e0 && e1 && e1 > 0) epsGrowth = ((e0 - e1) / Math.abs(e1)) * 100;
    }

    return {
      ticker,
      name: p.companyName || ticker,
      price: q.price,
      change1m: q.priceAvg50 ? ((q.price - q.priceAvg50) / q.priceAvg50) * 100 : null,
      change6m: q.priceAvg200 ? ((q.price - q.priceAvg200) / q.priceAvg200) * 100 : null,
      week52High: q.yearHigh,
      week52Low: q.yearLow,
      pe: q.pe,
      pb: m?.pbRatioTTM,
      ps: m?.priceToSalesRatioTTM,
      evEbitda: m?.enterpriseValueOverEBITDATTM,
      revenueGrowth,
      epsGrowth,
      grossMargin: m?.grossProfitMarginTTM ? m.grossProfitMarginTTM * 100 : null,
      netMargin: p.netProfitMargin ? p.netProfitMargin : (m?.netProfitMarginTTM ? m.netProfitMarginTTM * 100 : null),
      roe: m?.roeTTM ? m.roeTTM * 100 : null,
      debtEquity: m?.debtToEquityTTM,
      currentRatio: m?.currentRatioTTM,
      analystRating: rat?.ratingScore || null,
      analystRecommendation: rat?.ratingRecommendation || null,
      sector: p.sector,
      marketCap: p.mktCap,
      beta: q.beta,
      volume: q.volume,
      avgVolume: q.avgVolume,
    };
  } catch(e) {
    console.warn(`Failed ${ticker}:`, e);
    return null;
  }
}

// ── Scoring algorithm ──
function scoreStock(s, strategy) {
  const W = {
    balanced: { momentum:0.20, value:0.20, growth:0.25, quality:0.20, sentiment:0.15 },
    momentum: { momentum:0.45, value:0.05, growth:0.25, quality:0.10, sentiment:0.15 },
    value:    { momentum:0.10, value:0.45, growth:0.15, quality:0.20, sentiment:0.10 },
    growth:   { momentum:0.15, value:0.05, growth:0.50, quality:0.15, sentiment:0.15 },
    quality:  { momentum:0.10, value:0.15, growth:0.20, quality:0.45, sentiment:0.10 },
  }[strategy] || { momentum:0.20, value:0.20, growth:0.25, quality:0.20, sentiment:0.15 };

  // Momentum: 6M return (−40 to +80 → 0–100), 52-week position (0–100)
  let momParts = [];
  if (s.change6m !== null) momParts.push(clamp((s.change6m + 40) / 120 * 100));
  if (s.week52High && s.week52Low && s.price) {
    const range = s.week52High - s.week52Low;
    if (range > 0) momParts.push(clamp((s.price - s.week52Low) / range * 100));
  }
  if (s.change1m !== null) momParts.push(clamp((s.change1m + 20) / 50 * 100));
  const momentum = momParts.length ? avg(momParts) : 50;

  // Value: lower PE/PB/PS = better
  let valParts = [];
  if (s.pe && s.pe > 0 && s.pe < 200) valParts.push(clamp((80 - Math.min(s.pe, 80)) / 70 * 100));
  if (s.pb && s.pb > 0 && s.pb < 30)  valParts.push(clamp((15 - Math.min(s.pb, 15)) / 14 * 100));
  if (s.ps && s.ps > 0 && s.ps < 30)  valParts.push(clamp((15 - Math.min(s.ps, 15)) / 14 * 100));
  if (s.evEbitda && s.evEbitda > 0)    valParts.push(clamp((40 - Math.min(s.evEbitda, 40)) / 39 * 100));
  const value = valParts.length ? avg(valParts) : 50;

  // Growth: revenue growth + EPS growth
  let groParts = [];
  if (s.revenueGrowth !== null) groParts.push(clamp((s.revenueGrowth + 10) / 60 * 100));
  if (s.epsGrowth !== null)     groParts.push(clamp((s.epsGrowth + 10) / 80 * 100));
  const growth = groParts.length ? avg(groParts) : 50;

  // Quality: margins, ROE, debt, liquidity
  let quaParts = [];
  if (s.grossMargin !== null) quaParts.push(clamp(s.grossMargin));
  if (s.netMargin !== null)   quaParts.push(clamp(s.netMargin * 2.5));
  if (s.roe !== null)         quaParts.push(clamp(s.roe * 1.5));
  if (s.debtEquity !== null)  quaParts.push(clamp(100 - Math.min(s.debtEquity * 15, 100)));
  if (s.currentRatio !== null) quaParts.push(clamp((Math.min(s.currentRatio, 3) / 3) * 100));
  const quality = quaParts.length ? avg(quaParts) : 50;

  // Sentiment: analyst rating (1=strong sell → 5=strong buy → normalise to 0–100)
  let sentiment = 50;
  if (s.analystRating !== null && s.analystRating >= 1 && s.analystRating <= 5) {
    sentiment = (s.analystRating - 1) / 4 * 100;
  }

  const total = Math.round(
    momentum  * W.momentum +
    value     * W.value +
    growth    * W.growth +
    quality   * W.quality +
    sentiment * W.sentiment
  );

  return { total: clamp(total), momentum: Math.round(momentum), value: Math.round(value), growth: Math.round(growth), quality: Math.round(quality), sentiment: Math.round(sentiment) };
}

function clamp(v) { return Math.max(0, Math.min(100, isNaN(v) ? 50 : v)); }
function avg(arr) { return arr.reduce((a,b)=>a+b,0)/arr.length; }

function getSignal(s) {
  if (s >= 72) return { label:'STRONG BUY', cls:'sig-sb' };
  if (s >= 58) return { label:'BUY', cls:'sig-b' };
  if (s >= 40) return { label:'HOLD', cls:'sig-h' };
  return { label:'AVOID', cls:'sig-av' };
}

function scoreColor(s) {
  if (s >= 70) return 'var(--green)';
  if (s >= 55) return 'var(--accent)';
  if (s >= 40) return 'var(--gold)';
  return 'var(--red)';
}

function fmtPct(v, dec=1) {
  if (v === null || v === undefined || isNaN(v)) return '<span class="dim">N/A</span>';
  const cls = v >= 0 ? 'pos' : 'neg';
  return `<span class="${cls}">${v >= 0 ? '+' : ''}${v.toFixed(dec)}%</span>`;
}

function fmtNum(v, dec=1, suffix='') {
  if (v === null || v === undefined || isNaN(v)) return '<span class="dim">N/A</span>';
  return `<span class="neu">${v.toFixed(dec)}${suffix}</span>`;
}

function fmtPrice(v) {
  if (!v) return 'N/A';
  return `$${v.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
}

function setProgress(pct, step) {
  const f = document.getElementById('progFill');
  const s = document.getElementById('progStep');
  if (f) f.style.width = pct + '%';
  if (s) s.textContent = step;
}

// ── Main run function ──
async function runScreener() {
  const key = getKey();
  if (!key) { alert('Please enter your FMP API key first.'); return; }

  const tickersRaw = document.getElementById('tickers').value;
  const tickers = tickersRaw.split(',').map(t => t.trim().toUpperCase()).filter(Boolean);
  if (!tickers.length) { alert('Enter at least one ticker.'); return; }

  const strategy = document.getElementById('strategy').value;
  const minScore = parseInt(document.getElementById('minScore').value) || 0;
  const sortBy = document.getElementById('sortBy').value;

  const btn = document.getElementById('runBtn');
  btn.disabled = true;
  btn.textContent = '⟳ FETCHING DATA...';
  document.getElementById('summaryGrid').style.display = 'none';

  document.getElementById('resultArea').innerHTML = `
    <div class="loader">
      <div class="loader-title">// Fetching Live Market Data</div>
      <div class="progress-track"><div class="progress-fill" id="progFill"></div></div>
      <div class="loader-step" id="progStep">Initialising...</div>
    </div>`;

  // Fetch all stocks with progress
  const results = [];
  for (let i = 0; i < tickers.length; i++) {
    const t = tickers[i];
    setProgress(Math.round((i / tickers.length) * 85), `Scoring ${t}... (${i+1}/${tickers.length})`);
    const data = await fetchStockData(t);
    if (data) {
      data.scores = scoreStock(data, strategy);
      results.push(data);
    }
    // Small delay to avoid rate limiting
    if (i < tickers.length - 1) await new Promise(r => setTimeout(r, 200));
  }

  setProgress(100, 'Ranking results...');
  await new Promise(r => setTimeout(r, 300));

  btn.disabled = false;
  btn.textContent = '▶ ANALYSE STOCKS';

  // Filter and sort
  let filtered = results.filter(r => r.scores.total >= minScore);
  filtered.sort((a, b) => {
    if (sortBy === 'score') return b.scores.total - a.scores.total;
    if (sortBy === 'momentum') return b.scores.momentum - a.scores.momentum;
    if (sortBy === 'growth') return b.scores.growth - a.scores.growth;
    if (sortBy === 'value') return b.scores.value - a.scores.value;
    if (sortBy === 'quality') return b.scores.quality - a.scores.quality;
    return b.scores.total - a.scores.total;
  });

  cachedResults = filtered;

  if (!filtered.length) {
    document.getElementById('resultArea').innerHTML = `<div class="state-msg"><div class="big">∅</div><p>No results. Try lowering minimum score or check your API key.</p></div>`;
    return;
  }

  // Summary
  const sb = filtered.filter(r => r.scores.total >= 72).length;
  const buys = filtered.filter(r => r.scores.total >= 58 && r.scores.total < 72).length;
  const avgScore = Math.round(filtered.reduce((a,b) => a + b.scores.total, 0) / filtered.length);
  const topPick = filtered[0];

  document.getElementById('summaryGrid').style.display = 'grid';
  document.getElementById('summaryGrid').innerHTML = `
    <div class="sum-card">
      <div class="sc-label">Analysed</div>
      <div class="sc-val" style="color:var(--accent)">${filtered.length}</div>
      <div class="sc-sub">stocks screened</div>
    </div>
    <div class="sum-card">
      <div class="sc-label">Strong Buys</div>
      <div class="sc-val" style="color:var(--green)">${sb}</div>
      <div class="sc-sub">score ≥ 72</div>
    </div>
    <div class="sum-card">
      <div class="sc-label">Buy Signals</div>
      <div class="sc-val" style="color:var(--accent)">${buys}</div>
      <div class="sc-sub">score 58–71</div>
    </div>
    <div class="sum-card">
      <div class="sc-label">Avg Score</div>
      <div class="sc-val">${avgScore}</div>
      <div class="sc-sub">composite</div>
    </div>
    <div class="sum-card">
      <div class="sc-label">Top Pick</div>
      <div class="sc-val" style="color:var(--gold);font-size:1.1rem">${topPick.ticker}</div>
      <div class="sc-sub">score ${topPick.scores.total}</div>
    </div>`;

  // Table
  let html = `
    <div class="table-head">
      <div>Stock</div>
      <div>Price</div>
      <div>6M Ret.</div>
      <div>Rev. Gr.</div>
      <div>Net Mgn.</div>
      <div>P/E</div>
      <div>ROE</div>
      <div>QUANT Score</div>
      <div>Signal</div>
    </div>`;

  filtered.forEach((s, i) => {
    const sig = getSignal(s.scores.total);
    const color = scoreColor(s.scores.total);
    const rankCls = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : '';
    const rankBadge = i === 0 ? '<div class="rank-badge rank-gold">★ TOP PICK</div>'
                    : i === 1 ? '<div class="rank-badge rank-silver">#2</div>'
                    : i === 2 ? '<div class="rank-badge rank-bronze">#3</div>' : '';
    const delay = Math.min(i * 0.05, 0.5);

    html += `
      <div class="stock-row ${rankCls}" style="animation-delay:${delay}s" onclick="showDetail(${i})">
        <div>
          <div class="si-ticker">${s.ticker}</div>
          <div class="si-name">${s.name}</div>
          ${rankBadge}
        </div>
        <div class="cell neu">${fmtPrice(s.price)}</div>
        <div class="cell">${fmtPct(s.change6m)}</div>
        <div class="cell">${fmtPct(s.revenueGrowth)}</div>
        <div class="cell">${fmtPct(s.netMargin)}</div>
        <div class="cell">${s.pe ? s.pe.toFixed(1)+'x' : '<span class="dim">N/A</span>'}</div>
        <div class="cell">${fmtPct(s.roe)}</div>
        <div class="score-col">
          <div class="score-top">
            <div class="score-number" style="color:${color}">${s.scores.total}</div>
          </div>
          <div class="score-bars">
            ${miniBar(s.scores.momentum, 'var(--gold)')}
            ${miniBar(s.scores.growth, 'var(--accent)')}
            ${miniBar(s.scores.quality, '#b388ff')}
          </div>
        </div>
        <div class="sig ${sig.cls}">${sig.label}</div>
      </div>`;
  });

  document.getElementById('resultArea').innerHTML = html;
}

function miniBar(val, color) {
  return `<div class="mini-bar"><div class="mini-fill" style="width:${val}%;background:${color}"></div></div>`;
}

// ── Detail modal ──
function showDetail(idx) {
  const s = cachedResults[idx];
  if (!s) return;
  const sig = getSignal(s.scores.total);
  const color = scoreColor(s.scores.total);

  const analysis = generateAnalysis(s);

  document.getElementById('modalContent').innerHTML = `
    <div class="modal-header">
      <div>
        <div class="modal-ticker">${s.ticker}</div>
        <div style="font-size:0.7rem;color:var(--muted);margin-top:4px">${s.name} · ${s.sector || 'N/A'}</div>
      </div>
      <button class="modal-close" onclick="document.getElementById('modalOverlay').style.display='none'">✕</button>
    </div>

    <div style="display:flex;align-items:baseline;gap:16px;margin-bottom:20px">
      <div class="modal-score-big" style="color:${color}">${s.scores.total}</div>
      <div>
        <div class="sig ${sig.cls}" style="display:inline-block">${sig.label}</div>
        <div style="font-size:0.62rem;color:var(--muted);margin-top:4px">Analyst: ${s.analystRecommendation || 'N/A'}</div>
      </div>
    </div>

    <div class="modal-factors">
      ${mfItem('Momentum', s.scores.momentum, 'var(--gold)', fmtPct(s.change6m, 1))}
      ${mfItem('Value', s.scores.value, 'var(--green)', s.pe ? s.pe.toFixed(1)+'x P/E' : 'N/A')}
      ${mfItem('Growth', s.scores.growth, 'var(--accent)', fmtPct(s.revenueGrowth, 1))}
      ${mfItem('Quality', s.scores.quality, '#b388ff', fmtPct(s.netMargin, 1))}
      ${mfItem('Sentiment', s.scores.sentiment, '#ff9d4d', s.analystRecommendation || 'N/A')}
      <div class="mf-item">
        <div class="mf-label">Market Cap</div>
        <div class="mf-val" style="color:var(--text);font-size:0.85rem">${s.marketCap ? '$' + (s.marketCap/1e9).toFixed(1)+'B' : 'N/A'}</div>
        <div style="font-size:0.6rem;color:var(--muted);margin-top:4px">Beta: ${s.beta?.toFixed(2) || 'N/A'}</div>
      </div>
    </div>

    <div class="modal-analysis">
      <h4>// AI Analysis</h4>
      ${analysis}
    </div>`;

  document.getElementById('modalOverlay').style.display = 'flex';
}

function mfItem(label, score, color, sub) {
  return `
    <div class="mf-item">
      <div class="mf-label">${label}</div>
      <div class="mf-val" style="color:${color}">${score}<span style="font-size:0.6rem;color:var(--muted)">/100</span></div>
      <div class="mf-bar"><div class="mf-fill" style="width:${score}%;background:${color}"></div></div>
      <div style="font-size:0.6rem;color:var(--muted);margin-top:4px">${sub}</div>
    </div>`;
}

function generateAnalysis(s) {
  const parts = [];

  // Momentum
  if (s.change6m !== null) {
    if (s.change6m > 30) parts.push(`Strong upward momentum with ${s.change6m.toFixed(1)}% 6-month gain suggests institutional accumulation.`);
    else if (s.change6m > 10) parts.push(`Moderate positive momentum over 6 months — trend is constructive.`);
    else if (s.change6m < -15) parts.push(`Significant price decline of ${s.change6m.toFixed(1)}% over 6 months signals caution.`);
    else parts.push(`Price momentum is relatively flat — watching for directional catalyst.`);
  }

  // Growth
  if (s.revenueGrowth !== null) {
    if (s.revenueGrowth > 30) parts.push(`Exceptional revenue growth of ${s.revenueGrowth.toFixed(1)}% YoY indicates strong business expansion.`);
    else if (s.revenueGrowth > 10) parts.push(`Solid revenue growth of ${s.revenueGrowth.toFixed(1)}% YoY shows healthy business trajectory.`);
    else if (s.revenueGrowth < 0) parts.push(`Revenue declined ${Math.abs(s.revenueGrowth).toFixed(1)}% — headwinds present.`);
  }

  // Value
  if (s.pe) {
    if (s.pe < 15) parts.push(`Low P/E of ${s.pe.toFixed(1)}x suggests the stock may be undervalued relative to earnings.`);
    else if (s.pe > 50) parts.push(`Elevated P/E of ${s.pe.toFixed(1)}x implies high growth expectations are priced in — execution risk applies.`);
  }

  // Quality
  if (s.netMargin !== null && s.netMargin > 20) parts.push(`Strong net margin of ${s.netMargin.toFixed(1)}% reflects durable competitive advantage.`);
  if (s.debtEquity !== null && s.debtEquity > 2) parts.push(`Elevated debt/equity ratio of ${s.debtEquity.toFixed(2)} warrants monitoring of balance sheet health.`);
  if (s.roe !== null && s.roe > 20) parts.push(`ROE of ${s.roe.toFixed(1)}% demonstrates efficient capital allocation.`);

  // Sentiment
  if (s.analystRecommendation) parts.push(`Consensus analyst recommendation: <strong style="color:var(--accent)">${s.analystRecommendation}</strong>.`);

  if (parts.length === 0) parts.push('Insufficient data available for full analysis. Check that your API key has access to this ticker.');

  return parts.map(p => `<p style="margin-bottom:6px">→ ${p}</p>`).join('');
}

function closeModal(e) {
  if (e.target.id === 'modalOverlay') document.getElementById('modalOverlay').style.display = 'none';
}
</script>
</body>
</html>
